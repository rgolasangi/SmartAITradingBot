
# AI Trading Agent - Complete Deployment Guide

## 🚀 Production Deployment to Google Cloud Platform

This guide provides step-by-step instructions for deploying the AI Trading Agent to Google Cloud Platform in a production-ready configuration.

## 📋 Prerequisites

### Required Accounts & Access
- **Google Cloud Platform Account** with billing enabled
- **Zerodha Trading Account** with API access enabled
- **Domain Name** (optional but recommended for production)
- **SSL Certificate** (can be auto-generated by GCP)

### Required Tools
- `gcloud` CLI tool installed and configured
- `kubectl` CLI tool installed
- `docker` installed (for local testing)
- `git` for version control

### API Credentials Required
```bash
# Zerodha API Credentials (from Zerodha Developer Console)
ZERODHA_API_KEY=your_api_key_here
ZERODHA_API_SECRET=your_api_secret_here
ZERODHA_ACCESS_TOKEN=your_access_token_here

# Optional: OpenAI API Key (for enhanced NLP features)
OPENAI_API_KEY=your_openai_key_here
```

## 🔧 Pre-Deployment Setup

### 1. Google Cloud Project Setup

```bash
# Create new GCP project
gcloud projects create ai-trading-prod-$(date +%s) --name="AI Trading Agent Production"

# Set as current project
export PROJECT_ID=ai-trading-prod-$(date +%s)
gcloud config set project $PROJECT_ID

# Enable billing (required for GKE and other services)
# Note: This must be done through the GCP Console
echo "Please enable billing for project $PROJECT_ID in the GCP Console"
echo "https://console.cloud.google.com/billing/projects"
```

### 2. Enable Required APIs

```bash
# Enable all required Google Cloud APIs
gcloud services enable container.googleapis.com
gcloud services enable cloudbuild.googleapis.com
gcloud services enable containerregistry.googleapis.com
gcloud services enable sqladmin.googleapis.com
gcloud services enable redis.googleapis.com
gcloud services enable monitoring.googleapis.com
gcloud services enable logging.googleapis.com
gcloud services enable secretmanager.googleapis.com
```

### 3. Set Up Authentication

```bash
# Create service account for deployment
gcloud iam service-accounts create ai-trading-deploy \
    --display-name="AI Trading Deployment Service Account"

# Grant necessary permissions
gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member="serviceAccount:ai-trading-deploy@$PROJECT_ID.iam.gserviceaccount.com" \
    --role="roles/container.admin"

gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member="serviceAccount:ai-trading-deploy@$PROJECT_ID.iam.gserviceaccount.com" \
    --role="roles/cloudsql.admin"

# Download service account key
gcloud iam service-accounts keys create ~/ai-trading-key.json \
    --iam-account=ai-trading-deploy@$PROJECT_ID.iam.gserviceaccount.com

# Set environment variable
export GOOGLE_APPLICATION_CREDENTIALS=~/ai-trading-key.json
```

## 🏗️ Infrastructure Deployment

### 1. Create Google Kubernetes Engine Cluster

```bash
# Create GKE cluster with optimal configuration for trading workloads
gcloud container clusters create ai-trading-cluster \
    --zone=us-central1-a \
    --machine-type=e2-standard-4 \
    --num-nodes=3 \
    --enable-autoscaling \
    --min-nodes=2 \
    --max-nodes=10 \
    --enable-autorepair \
    --enable-autoupgrade \
    --disk-size=50GB \
    --disk-type=pd-ssd \
    --enable-ip-alias \
    --network=default \
    --subnetwork=default \
    --addons=HorizontalPodAutoscaling,HttpLoadBalancing,NetworkPolicy \
    --enable-network-policy \
    --enable-shielded-nodes \
    --shielded-secure-boot \
    --shielded-integrity-monitoring

# Get cluster credentials
gcloud container clusters get-credentials ai-trading-cluster --zone=us-central1-a
```

### 2. Create Cloud SQL PostgreSQL Instance

```bash
# Create PostgreSQL instance for production workload
gcloud sql instances create ai-trading-postgres \
    --database-version=POSTGRES_15 \
    --tier=db-custom-2-4096 \
    --region=us-central1 \
    --storage-type=SSD \
    --storage-size=100GB \
    --storage-auto-increase \
    --backup-start-time=02:00 \
    --enable-bin-log \
    --maintenance-window-day=SUN \
    --maintenance-window-hour=03 \
    --maintenance-release-channel=production \
    --deletion-protection

# Create database and user
gcloud sql databases create ai_trading_db --instance=ai-trading-postgres

# Generate secure password
DB_PASSWORD=$(openssl rand -base64 32)
echo "Database password: $DB_PASSWORD" > ~/db-password.txt

# Create database user
gcloud sql users create trading_user \
    --instance=ai-trading-postgres \
    --password=$DB_PASSWORD

# Get connection name for later use
DB_CONNECTION_NAME=$(gcloud sql instances describe ai-trading-postgres --format="value(connectionName)")
echo "Database connection name: $DB_CONNECTION_NAME"
```

### 3. Create Redis Instance

```bash
# Create Redis instance for caching and session management
gcloud redis instances create ai-trading-redis \
    --size=2 \
    --region=us-central1 \
    --redis-version=redis_7_0 \
    --tier=standard-ha \
    --auth-enabled

# Get Redis host and auth string
REDIS_HOST=$(gcloud redis instances describe ai-trading-redis --region=us-central1 --format="value(host)")
REDIS_AUTH=$(gcloud redis instances get-auth-string ai-trading-redis --region=us-central1)
echo "Redis host: $REDIS_HOST"
echo "Redis auth: $REDIS_AUTH" > ~/redis-auth.txt
```

## 🔐 Secrets Management

### 1. Create Kubernetes Secrets

```bash
# Create namespace first
kubectl create namespace ai-trading

# Create secrets for database
kubectl create secret generic db-credentials \
    --from-literal=username=trading_user \
    --from-literal=password=$DB_PASSWORD \
    --from-literal=host=$DB_CONNECTION_NAME \
    --namespace=ai-trading

# Create secrets for Redis
kubectl create secret generic redis-credentials \
    --from-literal=host=$REDIS_HOST \
    --from-literal=auth=$REDIS_AUTH \
    --namespace=ai-trading

# Create secrets for Zerodha API (replace with your actual credentials)
kubectl create secret generic zerodha-api \
    --from-literal=api-key=YOUR_ZERODHA_API_KEY \
    --from-literal=api-secret=YOUR_ZERODHA_API_SECRET \
    --from-literal=access-token=YOUR_ZERODHA_ACCESS_TOKEN \
    --namespace=ai-trading

# Create application secrets
kubectl create secret generic app-secrets \
    --from-literal=secret-key=$(openssl rand -base64 32) \
    --from-literal=admin-username=admin \
    --from-literal=admin-password=$(openssl rand -base64 16) \
    --namespace=ai-trading

# Optional: OpenAI API secret
kubectl create secret generic openai-api \
    --from-literal=api-key=YOUR_OPENAI_API_KEY \
    --namespace=ai-trading
```

### 2. Update Kubernetes Configurations

```bash
# Update the Kubernetes deployment files with your project ID
sed -i "s/YOUR_PROJECT_ID/$PROJECT_ID/g" kubernetes/backend-deployment.yaml
sed -i "s/YOUR_PROJECT_ID/$PROJECT_ID/g" kubernetes/frontend-deployment.yaml

# Update database connection in backend deployment
sed -i "s/postgres-service/$DB_CONNECTION_NAME/g" kubernetes/backend-deployment.yaml
```

## 🐳 Container Build and Deployment

### 1. Build and Push Docker Images

```bash
# Configure Docker to use gcloud as credential helper
gcloud auth configure-docker

# Build backend image
docker build -t gcr.io/$PROJECT_ID/ai-trading-backend:v1.0 ./ai_trading_agent
docker push gcr.io/$PROJECT_ID/ai-trading-backend:v1.0

# Tag as latest
docker tag gcr.io/$PROJECT_ID/ai-trading-backend:v1.0 gcr.io/$PROJECT_ID/ai-trading-backend:latest
docker push gcr.io/$PROJECT_ID/ai-trading-backend:latest

# Build frontend image
docker build -t gcr.io/$PROJECT_ID/ai-trading-frontend:v1.0 ./ai-trading-dashboard
docker push gcr.io/$PROJECT_ID/ai-trading-frontend:v1.0

# Tag as latest
docker tag gcr.io/$PROJECT_ID/ai-trading-frontend:v1.0 gcr.io/$PROJECT_ID/ai-trading-frontend:latest
docker push gcr.io/$PROJECT_ID/ai-trading-frontend:latest
```

### 2. Deploy to Kubernetes

```bash
# Apply all Kubernetes configurations
kubectl apply -f kubernetes/namespace.yaml
kubectl apply -f kubernetes/configmap.yaml
kubectl apply -f kubernetes/postgres-deployment.yaml
kubectl apply -f kubernetes/redis-deployment.yaml
kubectl apply -f kubernetes/backend-deployment.yaml
kubectl apply -f kubernetes/frontend-deployment.yaml

# Wait for deployments to be ready
kubectl wait --for=condition=available --timeout=600s deployment/ai-trading-backend -n ai-trading
kubectl wait --for=condition=available --timeout=600s deployment/ai-trading-frontend -n ai-trading

# Check deployment status
kubectl get pods -n ai-trading
kubectl get services -n ai-trading
```

## 🌐 Network and SSL Configuration

### 1. Reserve Static IP Address

```bash
# Reserve global static IP for the load balancer
gcloud compute addresses create ai-trading-ip --global

# Get the reserved IP address
STATIC_IP=$(gcloud compute addresses describe ai-trading-ip --global --format="value(address)")
echo "Reserved IP address: $STATIC_IP"
```

### 2. Configure Domain and SSL

```bash
# If you have a domain, create DNS A record pointing to $STATIC_IP
echo "Create DNS A record: your-domain.com -> $STATIC_IP"

# Update ingress configuration with your domain
sed -i "s/your-domain.com/YOUR_ACTUAL_DOMAIN/g" kubernetes/frontend-deployment.yaml

# Apply ingress configuration
kubectl apply -f kubernetes/frontend-deployment.yaml
```

### 3. Set Up SSL Certificate

```bash
# Create managed SSL certificate (if using custom domain)
kubectl apply -f - <<EOF
apiVersion: networking.gke.io/v1
kind: ManagedCertificate
metadata:
  name: ai-trading-ssl-cert
  namespace: ai-trading
spec:
  domains:
    - YOUR_ACTUAL_DOMAIN
EOF
```

## 📊 Monitoring and Logging Setup

### 1. Enable GKE Monitoring

```bash
# Update cluster to enable monitoring and logging
gcloud container clusters update ai-trading-cluster \
    --zone=us-central1-a \
    --enable-cloud-logging \
    --enable-cloud-monitoring

# Create monitoring dashboard
gcloud alpha monitoring dashboards create --config-from-file=monitoring/dashboard.json
```

### 2. Set Up Alerting

```bash
# Create alerting policies
gcloud alpha monitoring policies create --policy-from-file=monitoring/alerts.yaml

# Create notification channels (email)
gcloud alpha monitoring channels create \
    --display-name="Trading Alerts" \
    --type=email \
    --channel-labels=email_address=your-email@example.com
```

## 🧪 Post-Deployment Testing

### 1. Health Checks

```bash
# Get external IP of the frontend service
EXTERNAL_IP=$(kubectl get service ai-trading-frontend-service -n ai-trading -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

# Test health endpoint
curl -f http://$EXTERNAL_IP/health

# Test API endpoints
curl -f http://$EXTERNAL_IP/api/system/status
```

### 2. Load Testing

```bash
# Install Apache Bench for load testing
sudo apt-get install apache2-utils

# Run load test
ab -n 1000 -c 10 http://$EXTERNAL_IP/api/system/status

# Run comprehensive integration tests
python test_integration.py --url http://$EXTERNAL_IP
```

## 🔄 CI/CD Pipeline Setup

### 1. Set Up Cloud Build Triggers

```bash
# Connect your GitHub repository to Cloud Build
gcloud builds triggers create github \
    --repo-name=ai-trading-agent \
    --repo-owner=YOUR_GITHUB_USERNAME \
    --branch-pattern="^main$" \
    --build-config=cloudbuild.yaml

# Grant Cloud Build permissions
PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format="value(projectNumber)")
gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member=serviceAccount:$PROJECT_NUMBER@cloudbuild.gserviceaccount.com \
    --role=roles/container.developer
```

### 2. Automated Deployment

```bash
# Update cloudbuild.yaml with your project ID and cluster details
sed -i "s/YOUR_PROJECT_ID/$PROJECT_ID/g" cloudbuild.yaml
sed -i "s/your-gcp-project-id/$PROJECT_ID/g" cloudbuild.yaml

# Commit and push to trigger first automated build
git add .
git commit -m "Configure production deployment"
git push origin main
```

## 🔧 Configuration Management

### 1. Environment-Specific Configuration

```bash
# Create production configuration
kubectl create configmap ai-trading-prod-config \
    --from-literal=environment=production \
    --from-literal=log-level=INFO \
    --from-literal=max-daily-loss=50000 \
    --from-literal=max-position-size=500000 \
    --namespace=ai-trading
```

### 2. Feature Flags

```bash
# Create feature flags configmap
kubectl create configmap feature-flags \
    --from-literal=enable-paper-trading=false \
    --from-literal=enable-auto-trading=true \
    --from-literal=enable-advanced-analytics=true \
    --namespace=ai-trading
```

## 📈 Scaling Configuration

### 1. Horizontal Pod Autoscaler

```bash
# Create HPA for backend
kubectl autoscale deployment ai-trading-backend \
    --cpu-percent=70 \
    --min=2 \
    --max=10 \
    --namespace=ai-trading

# Create HPA for frontend
kubectl autoscale deployment ai-trading-frontend \
    --cpu-percent=80 \
    --min=2 \
    --max=5 \
    --namespace=ai-trading
```

### 2. Cluster Autoscaler

```bash
# Enable cluster autoscaler (already configured during cluster creation)
# Monitor cluster scaling
gcloud container clusters describe ai-trading-cluster --zone=us-central1-a | grep -A 5 autoscaling
```

## 🔐 Security Hardening

### 1. Network Policies

```bash
# Apply network policies for security
kubectl apply -f - <<EOF
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ai-trading-network-policy
  namespace: ai-trading
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ai-trading
  egress:
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80
EOF
```

### 2. Pod Security Policies

```bash
# Create pod security policy
kubectl apply -f - <<EOF
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: ai-trading-psp
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
EOF
```

## 📋 Maintenance Procedures

### 1. Database Maintenance

```bash
# Schedule automated backups
gcloud sql instances patch ai-trading-postgres \
    --backup-start-time=02:00 \
    --backup-location=us-central1

# Create manual backup
gcloud sql backups create --instance=ai-trading-postgres
```

### 2. Application Updates

```bash
# Rolling update deployment
kubectl set image deployment/ai-trading-backend \
    ai-trading-backend=gcr.io/$PROJECT_ID/ai-trading-backend:v1.1 \
    --namespace=ai-trading

# Monitor rollout
kubectl rollout status deployment/ai-trading-backend --namespace=ai-trading

# Rollback if needed
kubectl rollout undo deployment/ai-trading-backend --namespace=ai-trading
```

### 3. Log Management

```bash
# Set up log retention policies
gcloud logging sinks create ai-trading-logs \
    bigquery.googleapis.com/projects/$PROJECT_ID/datasets/trading_logs \
    --log-filter='resource.type="k8s_container" resource.labels.namespace_name="ai-trading"'
```

## 🚨 Disaster Recovery

### 1. Backup Strategy

```bash
# Create backup script
cat > backup.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)

# Backup database
gcloud sql export sql ai-trading-postgres gs://ai-trading-backups/db_backup_$DATE.sql \
    --database=ai_trading_db

# Backup Kubernetes configurations
kubectl get all -n ai-trading -o yaml > k8s_backup_$DATE.yaml
gsutil cp k8s_backup_$DATE.yaml gs://ai-trading-backups/

# Backup secrets (encrypted)
kubectl get secrets -n ai-trading -o yaml | gpg --symmetric --cipher-algo AES256 > secrets_backup_$DATE.yaml.gpg
gsutil cp secrets_backup_$DATE.yaml.gpg gs://ai-trading-backups/
EOF

chmod +x backup.sh
```

### 2. Recovery Procedures

```bash
# Create recovery script
cat > recovery.sh << 'EOF'
#!/bin/bash
BACKUP_DATE=$1

if [ -z "$BACKUP_DATE" ]; then
    echo "Usage: $0 <backup_date>"
    exit 1
fi

# Restore database
gsutil cp gs://ai-trading-backups/db_backup_$BACKUP_DATE.sql .
gcloud sql import sql ai-trading-postgres db_backup_$BACKUP_DATE.sql \
    --database=ai_trading_db

# Restore Kubernetes configurations
gsutil cp gs://ai-trading-backups/k8s_backup_$BACKUP_DATE.yaml .
kubectl apply -f k8s_backup_$BACKUP_DATE.yaml

echo "Recovery completed for backup date: $BACKUP_DATE"
EOF

chmod +x recovery.sh
```

## 📊 Monitoring Dashboard

### 1. Create Custom Dashboard

```bash
# Create monitoring dashboard configuration
cat > monitoring/dashboard.json << 'EOF'
{
  "displayName": "AI Trading Agent Dashboard",
  "mosaicLayout": {
    "tiles": [
      {
        "width": 6,
        "height": 4,
        "widget": {
          "title": "API Response Time",
          "xyChart": {
            "dataSets": [{
              "timeSeriesQuery": {
                "timeSeriesFilter": {
                  "filter": "resource.type=\"k8s_container\" resource.labels.namespace_name=\"ai-trading\"",
                  "aggregation": {
                    "alignmentPeriod": "60s",
                    "perSeriesAligner": "ALIGN_MEAN"
                  }
                }
              }
            }]
          }
        }
      }
    ]
  }
}
EOF
```

## 🎯 Performance Optimization

### 1. Database Optimization

```bash
# Connect to database and optimize
gcloud sql connect ai-trading-postgres --user=trading_user

# Run optimization queries
CREATE INDEX CONCURRENTLY idx_market_data_symbol_timestamp ON market_data (symbol, timestamp DESC);
CREATE INDEX CONCURRENTLY idx_options_data_symbol_timestamp ON options_data (symbol, timestamp DESC);
ANALYZE;
```

### 2. Application Optimization

```bash
# Update resource limits for better performance
kubectl patch deployment ai-trading-backend -n ai-trading -p '
{
  "spec": {
    "template": {
      "spec": {
        "containers": [{
          "name": "ai-trading-backend",
          "resources": {
            "requests": {
              "memory": "2Gi",
              "cpu": "1000m"
            },
            "limits": {
              "memory": "4Gi",
              "cpu": "2000m"
            }
          }
        }]
      }
    }
  }
}'
```

## ✅ Deployment Checklist

### Pre-Deployment
- [ ] GCP project created and billing enabled
- [ ] All required APIs enabled
- [ ] Service accounts created with proper permissions
- [ ] Zerodha API credentials obtained and tested
- [ ] Domain name configured (if using custom domain)

### Infrastructure
- [ ] GKE cluster created and configured
- [ ] Cloud SQL PostgreSQL instance created
- [ ] Redis instance created
- [ ] Static IP address reserved
- [ ] SSL certificate configured

### Application
- [ ] Docker images built and pushed to GCR
- [ ] Kubernetes secrets created
- [ ] All deployments applied and running
- [ ] Health checks passing
- [ ] Load balancer configured

### Security
- [ ] Network policies applied
- [ ] Pod security policies configured
- [ ] Secrets properly managed
- [ ] HTTPS enabled

### Monitoring
- [ ] Monitoring and logging enabled
- [ ] Alerting policies configured
- [ ] Dashboard created
- [ ] Backup procedures tested

### Testing
- [ ] Integration tests passing
- [ ] Load testing completed
- [ ] Disaster recovery tested
- [ ] Performance benchmarks met

## 🎉 Go Live!

Once all checklist items are complete:

1. **Final Testing**: Run comprehensive tests against production environment
2. **Gradual Rollout**: Start with paper trading mode
3. **Monitor Closely**: Watch all metrics and logs for the first 24 hours
4. **Enable Live Trading**: Gradually increase position sizes
5. **Continuous Monitoring**: Set up 24/7 monitoring and alerting

## 📞 Support and Maintenance

### Regular Maintenance Tasks
- Weekly: Review performance metrics and logs
- Monthly: Update dependencies and security patches
- Quarterly: Disaster recovery testing
- Annually: Full security audit

### Emergency Contacts
- Infrastructure Issues: GCP Support
- Application Issues: Development Team
- Trading Issues: Risk Management Team

---

**Congratulations! Your AI Trading Agent is now deployed and ready for production trading!**

*Remember to start with paper trading and gradually increase exposure as you gain confidence in the system.*

